<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>InterOS</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/react-draggable@4.4.5/build/web/react-draggable.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'MS Sans Serif', Arial, sans-serif;
      background: #008080;
      overflow: hidden;
      width: 100vw;
      height: 100vh;
    }

    .desktop {
      width: 100%;
      height: calc(100vh - 40px);
      position: relative;
      padding: 10px;
      display: grid;
      grid-template-columns: repeat(auto-fill, 90px);
      grid-auto-rows: 90px;
      gap: 10px;
      align-content: start;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .desktop-icon {
      width: 80px;
      height: 80px;
      text-align: center;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      -webkit-user-select: none;
    }

    .desktop-icon:active {
      opacity: 0.7;
    }

    .desktop-icon-image {
      width: 32px;
      height: 32px;
      margin: 0 auto 5px;
      background: #c0c0c0;
      border: 2px solid #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .desktop-icon-label {
      background: #fff;
      color: #000;
      padding: 2px 4px;
      font-size: 11px;
      word-wrap: break-word;
    }

    .taskbar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 40px;
      background: #c0c0c0;
      border-top: 2px solid #fff;
      display: flex;
      align-items: center;
      padding: 2px;
      z-index: 10000;
    }

    .start-button {
      height: 32px;
      padding: 0 20px;
      background: #c0c0c0;
      border: 2px outset #fff;
      font-weight: bold;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      -webkit-user-select: none;
    }

    .start-button:active {
      border-style: inset;
    }

    .start-button.active {
      border-style: inset;
    }

    .taskbar-buttons {
      display: flex;
      gap: 2px;
      margin-left: 10px;
      flex: 1;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .taskbar-button {
      height: 32px;
      padding: 0 10px;
      background: #c0c0c0;
      border: 2px outset #fff;
      font-size: 12px;
      cursor: pointer;
      white-space: nowrap;
      max-width: 160px;
      overflow: hidden;
      text-overflow: ellipsis;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      -webkit-user-select: none;
    }

    .taskbar-button.active {
      border-style: inset;
    }

    .taskbar-button:active {
      border-style: inset;
    }

    .clock {
      height: 32px;
      padding: 0 10px;
      background: #c0c0c0;
      border: 2px inset #fff;
      font-size: 12px;
      display: flex;
      align-items: center;
      margin-left: auto;
    }

    .window {
      position: absolute;
      background: #c0c0c0;
      border: 2px outset #fff;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
      min-width: 300px;
      min-height: 200px;
      display: flex;
      flex-direction: column;
      transition: all 0.1s ease;
    }

    .window.maximized {
      top: 0 !important;
      left: 0 !important;
      width: 100vw !important;
      height: calc(100vh - 40px) !important;
      transform: none !important;
    }

    .window-resizer {
      position: absolute;
      background: transparent;
    }

    .window-resizer.top {
      top: -5px;
      left: 5px;
      right: 5px;
      height: 10px;
      cursor: n-resize;
    }

    .window-resizer.bottom {
      bottom: -5px;
      left: 5px;
      right: 5px;
      height: 10px;
      cursor: s-resize;
    }

    .window-resizer.left {
      left: -5px;
      top: 5px;
      bottom: 5px;
      width: 10px;
      cursor: w-resize;
    }

    .window-resizer.right {
      right: -5px;
      top: 5px;
      bottom: 5px;
      width: 10px;
      cursor: e-resize;
    }

    .window-resizer.top-left {
      top: -5px;
      left: -5px;
      width: 15px;
      height: 15px;
      cursor: nw-resize;
    }

    .window-resizer.top-right {
      top: -5px;
      right: -5px;
      width: 15px;
      height: 15px;
      cursor: ne-resize;
    }

    .window-resizer.bottom-left {
      bottom: -5px;
      left: -5px;
      width: 15px;
      height: 15px;
      cursor: sw-resize;
    }

    .window-resizer.bottom-right {
      bottom: -5px;
      right: -5px;
      width: 15px;
      height: 15px;
      cursor: se-resize;
    }

    .window.maximized .window-resizer {
      display: none;
    }

    .window-titlebar {
      background: linear-gradient(to right, #000080, #1084d0);
      color: #fff;
      padding: 3px 5px;
      font-weight: bold;
      font-size: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: move;
    }

    .window-titlebar.inactive {
      background: linear-gradient(to right, #808080, #a0a0a0);
    }

    .window-controls {
      display: flex;
      gap: 2px;
    }

    .window-button {
      width: 18px;
      height: 18px;
      background: #c0c0c0;
      border: 1px outset #fff;
      font-size: 10px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      -webkit-user-select: none;
      touch-action: manipulation;
    }

    .window-button:active {
      border-style: inset;
    }

    .window-content {
      flex: 1;
      background: #fff;
      border: 2px inset #fff;
      margin: 2px;
      overflow: auto;
      padding: 10px;
      -webkit-overflow-scrolling: touch;
    }

    .start-menu {
      position: fixed;
      bottom: 42px;
      left: 2px;
      width: 250px;
      background: #c0c0c0;
      border: 2px outset #fff;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
      z-index: 9999;
    }

    .start-menu-header {
      background: linear-gradient(to right, #000080, #1084d0);
      color: #fff;
      padding: 5px 10px;
      font-weight: bold;
      transform: rotate(0deg);
      writing-mode: horizontal-tb;
    }

    .start-menu-item {
      padding: 8px 30px 8px 10px;
      cursor: pointer;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      -webkit-user-select: none;
      touch-action: manipulation;
    }

    .start-menu-item:hover {
      background: #000080;
      color: #fff;
    }

    .start-menu-item:active {
      background: #000060;
    }

    .login-screen {
      width: 100vw;
      height: 100vh;
      background: #008080;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .login-box {
      background: #c0c0c0;
      border: 2px outset #fff;
      padding: 20px;
      width: 400px;
    }

    .login-title {
      background: linear-gradient(to right, #000080, #1084d0);
      color: #fff;
      padding: 5px 10px;
      font-weight: bold;
      margin: -20px -20px 20px -20px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-size: 12px;
    }

    .form-group input {
      width: 100%;
      padding: 5px;
      border: 2px inset #fff;
      font-family: 'MS Sans Serif', Arial, sans-serif;
      font-size: 12px;
    }

    .button {
      padding: 5px 20px;
      background: #c0c0c0;
      border: 2px outset #fff;
      font-size: 12px;
      cursor: pointer;
      font-family: 'MS Sans Serif', Arial, sans-serif;
    }

    .button:active {
      border-style: inset;
    }

    .button-group {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    .app-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 20px;
      padding: 10px;
      max-height: none;
    }

    .app-item {
      text-align: center;
      cursor: pointer;
      padding: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }

    .app-item:hover {
      background: rgba(0, 0, 255, 0.1);
    }

    .app-icon {
      width: 48px;
      height: 48px;
      margin: 0 auto 8px;
      background: #c0c0c0;
      border: 2px solid #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      flex-shrink: 0;
    }

    .app-name {
      font-size: 11px;
      word-wrap: break-word;
      word-break: break-word;
      line-height: 1.3;
      max-width: 100%;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    const Draggable = window.ReactDraggable;

    // Storage utilities
    const STORAGE_KEY = 'os_installed_apps';
    const DESKTOP_APPS_KEY = 'os_desktop_apps';
    
    const getApps = () => {
      try {
        return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      } catch {
        return [];
      }
    };
    
    const saveApps = (apps) => {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(apps));
    };

    const getDesktopApps = () => {
      try {
        return JSON.parse(localStorage.getItem(DESKTOP_APPS_KEY) || '[]');
      } catch {
        return [];
      }
    };

    const saveDesktopApps = (appIds) => {
      localStorage.setItem(DESKTOP_APPS_KEY, JSON.stringify(appIds));
    };

    // Login Screen
    function LoginScreen({ onLogin }) {
      const [username, setUsername] = useState('');
      
      const handleSubmit = (e) => {
        e.preventDefault();
        if (username.trim()) {
          onLogin(username);
        }
      };
      
      return (
        <div className="login-screen">
          <div className="login-box">
            <div className="login-title">Welcome to InterOS</div>
            <form onSubmit={handleSubmit}>
              <div className="form-group">
                <label>User name:</label>
                <input
                  type="text"
                  value={username}
                  onChange={(e) => setUsername(e.target.value)}
                  autoFocus
                />
              </div>
              <div className="button-group">
                <button type="submit" className="button">OK</button>
              </div>
            </form>
          </div>
        </div>
      );
    }

    // Desktop Icon Component
    function DesktopIcon({ icon, label, onDoubleClick }) {
      const [lastTap, setLastTap] = React.useState(0);
      
      const handleTap = () => {
        const now = Date.now();
        const timeSinceLastTap = now - lastTap;
        
        if (timeSinceLastTap < 300 && timeSinceLastTap > 0) {
          // Double tap detected
          onDoubleClick();
          setLastTap(0);
        } else {
          setLastTap(now);
        }
      };
      
      return (
        <div 
          className="desktop-icon" 
          onDoubleClick={onDoubleClick}
          onClick={handleTap}
          onTouchEnd={(e) => {
            e.preventDefault();
            handleTap();
          }}
        >
          <div className="desktop-icon-image">{icon}</div>
          <div className="desktop-icon-label">{label}</div>
        </div>
      );
    }

    // Window Component
    function WindowFrame({ window, isActive, onClose, onFocus, onMinimize, onMaximize, onResize, children }) {
      const nodeRef = useRef(null);
      const [isResizing, setIsResizing] = useState(false);
      const resizeData = useRef({ direction: '', startX: 0, startY: 0, startWidth: 0, startHeight: 0, startLeft: 0, startTop: 0 });
      
      const handleTouchStart = (e) => {
        if (e.target.closest('.window-titlebar')) {
          onFocus();
        }
      };
      
      const handleDoubleClick = (e) => {
        if (e.target.closest('.window-titlebar') && !e.target.closest('.window-controls')) {
          onMaximize();
        }
      };

      const startResize = (e, direction) => {
        if (window.maximized) return;
        
        e.preventDefault();
        e.stopPropagation();
        
        const rect = nodeRef.current.getBoundingClientRect();
        const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
        const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
        
        resizeData.current = {
          direction,
          startX: clientX,
          startY: clientY,
          startWidth: rect.width,
          startHeight: rect.height,
          startLeft: rect.left,
          startTop: rect.top
        };
        
        setIsResizing(true);
        onFocus();
      };

      useEffect(() => {
        if (!isResizing) return;

        const handleMouseMove = (e) => {
          const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
          const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
          
          const deltaX = clientX - resizeData.current.startX;
          const deltaY = clientY - resizeData.current.startY;
          const { direction, startWidth, startHeight, startLeft, startTop } = resizeData.current;

          let newWidth = startWidth;
          let newHeight = startHeight;
          let newX = window.x;
          let newY = window.y;

          // Calculate new dimensions based on direction
          if (direction.includes('right')) {
            newWidth = Math.max(300, startWidth + deltaX);
          }
          if (direction.includes('left')) {
            newWidth = Math.max(300, startWidth - deltaX);
            newX = window.x + deltaX;
          }
          if (direction.includes('bottom')) {
            newHeight = Math.max(200, startHeight + deltaY);
          }
          if (direction.includes('top')) {
            newHeight = Math.max(200, startHeight - deltaY);
            newY = window.y + deltaY;
          }

          onResize(window.id, newWidth, newHeight, newX, newY);
        };

        const handleMouseUp = () => {
          setIsResizing(false);
        };

        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
        document.addEventListener('touchmove', handleMouseMove);
        document.addEventListener('touchend', handleMouseUp);

        return () => {
          document.removeEventListener('mousemove', handleMouseMove);
          document.removeEventListener('mouseup', handleMouseUp);
          document.removeEventListener('touchmove', handleMouseMove);
          document.removeEventListener('touchend', handleMouseUp);
        };
      }, [isResizing, window.id, window.x, window.y, onResize]);
      
      return (
        <Draggable
          handle=".window-titlebar"
          nodeRef={nodeRef}
          position={{ x: window.x || 100, y: window.y || 100 }}
          onDrag={(e, data) => {
            // Update position during drag
            onResize(window.id, window.width, window.height, data.x, data.y);
          }}
          enableUserSelectHack={false}
          disabled={window.maximized || isResizing}
        >
          <div
            ref={nodeRef}
            className={`window ${window.maximized ? 'maximized' : ''}`}
            style={{
              zIndex: isActive ? 1000 : window.zIndex || 1,
              width: window.maximized ? '100vw' : (window.width || 600),
              height: window.maximized ? 'calc(100vh - 40px)' : (window.height || 400),
              display: window.minimized ? 'none' : 'flex',
              top: window.maximized ? 0 : undefined,
              left: window.maximized ? 0 : undefined
            }}
            onMouseDown={onFocus}
            onTouchStart={handleTouchStart}
          >
            {/* Resize handles */}
            <div className="window-resizer top" onMouseDown={(e) => startResize(e, 'top')} onTouchStart={(e) => startResize(e, 'top')} />
            <div className="window-resizer bottom" onMouseDown={(e) => startResize(e, 'bottom')} onTouchStart={(e) => startResize(e, 'bottom')} />
            <div className="window-resizer left" onMouseDown={(e) => startResize(e, 'left')} onTouchStart={(e) => startResize(e, 'left')} />
            <div className="window-resizer right" onMouseDown={(e) => startResize(e, 'right')} onTouchStart={(e) => startResize(e, 'right')} />
            <div className="window-resizer top-left" onMouseDown={(e) => startResize(e, 'top-left')} onTouchStart={(e) => startResize(e, 'top-left')} />
            <div className="window-resizer top-right" onMouseDown={(e) => startResize(e, 'top-right')} onTouchStart={(e) => startResize(e, 'top-right')} />
            <div className="window-resizer bottom-left" onMouseDown={(e) => startResize(e, 'bottom-left')} onTouchStart={(e) => startResize(e, 'bottom-left')} />
            <div className="window-resizer bottom-right" onMouseDown={(e) => startResize(e, 'bottom-right')} onTouchStart={(e) => startResize(e, 'bottom-right')} />
            
            <div 
              className={`window-titlebar ${!isActive ? 'inactive' : ''}`}
              onDoubleClick={handleDoubleClick}
            >
              <span>{window.title}</span>
              <div className="window-controls">
                <div 
                  className="window-button" 
                  onClick={onMinimize}
                  onTouchEnd={(e) => { e.stopPropagation(); onMinimize(); }}
                >_</div>
                <div 
                  className="window-button" 
                  onClick={onMaximize}
                  onTouchEnd={(e) => { e.stopPropagation(); onMaximize(); }}
                >‚ñ°</div>
                <div 
                  className="window-button" 
                  onClick={onClose}
                  onTouchEnd={(e) => { e.stopPropagation(); onClose(); }}
                >√ó</div>
              </div>
            </div>
            <div className="window-content">
              {children}
            </div>
          </div>
        </Draggable>
      );
    }

    // Browser App (Installer)
    function BrowserApp() {
      const [name, setName] = useState('');
      const [url, setUrl] = useState('');
      const [installType, setInstallType] = useState('url'); // 'url' or 'file'
      const [apps, setApps] = useState(getApps());
      const fileInputRef = useRef(null);
      
      const handleFileSelect = (e) => {
        const file = e.target.files[0];
        if (file && file.type === 'text/html') {
          const reader = new FileReader();
          reader.onload = (event) => {
            const content = event.target.result;
            const newApp = {
              id: Date.now().toString(),
              title: name || file.name.replace('.html', ''),
              content: content,
              type: 'local',
              icon: 'üìÑ'
            };
            const updatedApps = [...apps, newApp];
            setApps(updatedApps);
            saveApps(updatedApps);
            setName('');
            alert('Local HTML file installed successfully!');
            if (fileInputRef.current) fileInputRef.current.value = '';
          };
          reader.readAsText(file);
        } else {
          alert('Please select an HTML file');
        }
      };
      
      const handleInstall = (e) => {
        e.preventDefault();
        if (name && url) {
          const newApp = {
            id: Date.now().toString(),
            title: name,
            url: url,
            type: 'url',
            icon: 'üåê'
          };
          const updatedApps = [...apps, newApp];
          setApps(updatedApps);
          saveApps(updatedApps);
          setName('');
          setUrl('');
          alert('Application installed successfully!');
        }
      };
      
      return (
        <div style={{ padding: '20px' }}>
          <h2 style={{ marginBottom: '20px' }}>Install New Application</h2>
          
          <div style={{ marginBottom: '20px', padding: '10px', background: '#f0f0f0', border: '2px inset #fff' }}>
            <div style={{ marginBottom: '10px' }}>
              <label style={{ marginRight: '20px' }}>
                <input 
                  type="radio" 
                  value="url" 
                  checked={installType === 'url'} 
                  onChange={(e) => setInstallType(e.target.value)}
                  style={{ marginRight: '5px' }}
                />
                Install from URL
              </label>
              <label>
                <input 
                  type="radio" 
                  value="file" 
                  checked={installType === 'file'} 
                  onChange={(e) => setInstallType(e.target.value)}
                  style={{ marginRight: '5px' }}
                />
                Install from Local File
              </label>
            </div>
          </div>

          {installType === 'url' ? (
            <form onSubmit={handleInstall}>
              <div className="form-group">
                <label>Application Name:</label>
                <input
                  type="text"
                  value={name}
                  onChange={(e) => setName(e.target.value)}
                  placeholder="e.g., Google"
                />
              </div>
              <div className="form-group">
                <label>URL:</label>
                <input
                  type="url"
                  value={url}
                  onChange={(e) => setUrl(e.target.value)}
                  placeholder="https://example.com"
                />
              </div>
              <div className="button-group">
                <button type="submit" className="button">Install from URL</button>
              </div>
            </form>
          ) : (
            <div>
              <div className="form-group">
                <label>Application Name (optional):</label>
                <input
                  type="text"
                  value={name}
                  onChange={(e) => setName(e.target.value)}
                  placeholder="Leave blank to use filename"
                />
              </div>
              <div className="form-group">
                <label>Select HTML File:</label>
                <input
                  ref={fileInputRef}
                  type="file"
                  accept=".html,.htm"
                  onChange={handleFileSelect}
                  style={{ padding: '5px', border: '2px inset #fff', width: '100%', background: '#fff' }}
                />
              </div>
              <div style={{ marginTop: '10px', padding: '10px', background: '#ffffcc', border: '1px solid #ccc', fontSize: '11px' }}>
                üìù <strong>Note:</strong> Select an HTML file from your computer. The file will be stored locally and can be run offline.
              </div>
            </div>
          )}
          
          <div style={{ marginTop: '30px' }}>
            <h3>Installed Apps ({apps.length})</h3>
            <div style={{ marginTop: '10px' }}>
              {apps.map(app => (
                <div key={app.id} style={{ padding: '5px', borderBottom: '1px solid #ccc' }}>
                  {app.icon} {app.title} {app.type === 'local' && <span style={{ fontSize: '10px', color: '#666' }}>(Local)</span>}
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    }

    // Explorer App (Library)
    function ExplorerApp({ onOpenApp }) {
      const [apps, setApps] = useState(getApps());
      const [desktopApps, setDesktopApps] = useState(getDesktopApps());
      
      const handleDelete = (id) => {
        if (confirm('Delete this application?')) {
          const updatedApps = apps.filter(app => app.id !== id);
          setApps(updatedApps);
          saveApps(updatedApps);
          
          // Remove from desktop if present
          const updatedDesktopApps = desktopApps.filter(appId => appId !== id);
          setDesktopApps(updatedDesktopApps);
          saveDesktopApps(updatedDesktopApps);
          
          // Notify parent to refresh desktop
          window.postMessage({ type: 'desktop-apps-updated' }, '*');
        }
      };
      
      const handleDownload = (app) => {
        if (app.type === 'local' && app.content) {
          // Download local HTML file
          const blob = new Blob([app.content], { type: 'text/html' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `${app.title}.html`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        } else if (app.type === 'url') {
          // Create a simple HTML wrapper for URL-based apps
          const htmlContent = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${app.title}</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100vh;
      overflow: hidden;
    }
    iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
  </style>
</head>
<body>
  <iframe src="${app.url}" title="${app.title}"></iframe>
</body>
</html>`;
          const blob = new Blob([htmlContent], { type: 'text/html' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `${app.title}.html`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }
      };

      const toggleDesktop = (appId) => {
        const isOnDesktop = desktopApps.includes(appId);
        let updatedDesktopApps;
        
        if (isOnDesktop) {
          updatedDesktopApps = desktopApps.filter(id => id !== appId);
        } else {
          updatedDesktopApps = [...desktopApps, appId];
        }
        
        setDesktopApps(updatedDesktopApps);
        saveDesktopApps(updatedDesktopApps);
        
        // Notify parent to refresh desktop
        window.postMessage({ type: 'desktop-apps-updated' }, '*');
      };
      
      return (
        <div>
          <div style={{ padding: '10px', background: '#c0c0c0', borderBottom: '2px solid #fff' }}>
            <strong>My Applications</strong> - {apps.length} installed
          </div>
          {apps.length === 0 ? (
            <div style={{ padding: '40px', textAlign: 'center', color: '#666' }}>
              No applications installed. Use Browser to install apps.
            </div>
          ) : (
            <div className="app-grid">
              {apps.map(app => {
                const isOnDesktop = desktopApps.includes(app.id);
                return (
                  <div key={app.id} className="app-item">
                    <div onDoubleClick={() => onOpenApp(app)}>
                      <div className="app-icon">{app.icon}</div>
                      <div className="app-name">{app.title}</div>
                    </div>
                    <div style={{ display: 'flex', gap: '5px', marginTop: '8px', justifyContent: 'center', flexWrap: 'wrap' }}>
                      <button 
                        className="button" 
                        style={{ fontSize: '9px', padding: '2px 6px' }}
                        onClick={() => toggleDesktop(app.id)}
                        title={isOnDesktop ? 'Remove from desktop' : 'Add to desktop'}
                      >
                        {isOnDesktop ? 'üìå' : 'üìç'}
                      </button>
                      <button 
                        className="button" 
                        style={{ fontSize: '9px', padding: '2px 6px' }}
                        onClick={() => handleDownload(app)}
                        title="Download to computer"
                      >
                        üíæ
                      </button>
                      <button 
                        className="button" 
                        style={{ fontSize: '9px', padding: '2px 6px' }}
                        onClick={() => handleDelete(app.id)}
                        title="Delete from OS"
                      >
                        üóëÔ∏è
                      </button>
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      );
    }

    // Webview App
    function WebviewApp({ url, content }) {
      if (content) {
        // Local HTML content
        return (
          <iframe 
            srcDoc={content} 
            title="Local Application"
            sandbox="allow-scripts allow-same-origin allow-forms"
          />
        );
      }
      // Remote URL
      return <iframe src={url} title="Web Application" />;
    }

    // Main OS Component
    function OS() {
      const [loggedIn, setLoggedIn] = useState(false);
      const [username, setUsername] = useState('');
      const [windows, setWindows] = useState([]);
      const [activeWindowId, setActiveWindowId] = useState(null);
      const [startMenuOpen, setStartMenuOpen] = useState(false);
      const [time, setTime] = useState(new Date());
      const [desktopApps, setDesktopApps] = useState([]);
      
      useEffect(() => {
        const timer = setInterval(() => setTime(new Date()), 1000);
        return () => clearInterval(timer);
      }, []);
      
      // Load desktop apps
      useEffect(() => {
        loadDesktopApps();
      }, []);
      
      // Listen for desktop apps updates
      useEffect(() => {
        const handleMessage = (event) => {
          if (event.data.type === 'desktop-apps-updated') {
            loadDesktopApps();
          }
        };
        window.addEventListener('message', handleMessage);
        return () => window.removeEventListener('message', handleMessage);
      }, []);
      
      const loadDesktopApps = () => {
        const desktopAppIds = getDesktopApps();
        const allApps = getApps();
        const apps = allApps.filter(app => desktopAppIds.includes(app.id));
        setDesktopApps(apps);
      };
      
      // Close start menu when clicking/tapping outside
      useEffect(() => {
        const handleClickOutside = (e) => {
          if (startMenuOpen && !e.target.closest('.start-button') && !e.target.closest('.start-menu')) {
            setStartMenuOpen(false);
          }
        };
        
        document.addEventListener('mousedown', handleClickOutside);
        document.addEventListener('touchstart', handleClickOutside);
        
        return () => {
          document.removeEventListener('mousedown', handleClickOutside);
          document.removeEventListener('touchstart', handleClickOutside);
        };
      }, [startMenuOpen]);
      
      // Listen for resize messages from apps
      useEffect(() => {
        const handleMessage = (event) => {
          if (event.data.type === 'resize-window') {
            // Find the window that sent the message
            const sourceWindow = windows.find(w => w.id === activeWindowId);
            if (sourceWindow) {
              setWindows(windows.map(w => 
                w.id === activeWindowId 
                  ? { ...w, width: event.data.width, height: event.data.height }
                  : w
              ));
            }
          } else if (event.data.type === 'get-window-size') {
            // Send current window size back to requesting app
            const currentWindow = windows.find(w => w.id === activeWindowId);
            if (currentWindow) {
              event.source.postMessage({
                type: 'window-size-update',
                width: currentWindow.width || 600,
                height: currentWindow.height || 400
              }, '*');
            }
          } else if (event.data.type === 'bulk-install-apps') {
            // Handle bulk app installation
            const currentApps = getApps();
            const newApps = event.data.apps.map(app => ({
              ...app,
              id: Date.now().toString() + Math.random().toString(36).substr(2, 9)
            }));
            const updatedApps = [...currentApps, ...newApps];
            saveApps(updatedApps);
            
            // Send confirmation back
            event.source.postMessage({
              type: 'apps-installed',
              count: newApps.length
            }, '*');
            
            alert(`Successfully installed ${newApps.length} app(s)!\n\nCheck File Explorer to see them.`);
          }
        };
        
        window.addEventListener('message', handleMessage);
        return () => window.removeEventListener('message', handleMessage);
      }, [windows, activeWindowId]);
      
      const openWindow = (appType, appData = {}) => {
        const existingWindow = windows.find(w => w.appType === appType && w.appData?.id === appData.id);
        
        if (existingWindow) {
          setActiveWindowId(existingWindow.id);
          setWindows(windows.map(w => 
            w.id === existingWindow.id ? { ...w, minimized: false } : w
          ));
        } else {
          const newWindow = {
            id: Date.now().toString(),
            appType,
            appData,
            title: appData.title || (appType === 'browser' ? 'Browser' : appType === 'explorer' ? 'File Explorer' : 'Application'),
            x: 50 + windows.length * 30,
            y: 50 + windows.length * 30,
            width: appType === 'webview' ? 800 : 600,
            height: appType === 'webview' ? 600 : 400,
            minimized: false,
            maximized: false,
            zIndex: 1
          };
          setWindows([...windows, newWindow]);
          setActiveWindowId(newWindow.id);
        }
        setStartMenuOpen(false);
      };
      
      const closeWindow = (id) => {
        setWindows(windows.filter(w => w.id !== id));
        if (activeWindowId === id) {
          setActiveWindowId(null);
        }
      };
      
      const minimizeWindow = (id) => {
        setWindows(windows.map(w => 
          w.id === id ? { ...w, minimized: true } : w
        ));
        if (activeWindowId === id) {
          setActiveWindowId(null);
        }
      };
      
      const maximizeWindow = (id) => {
        setWindows(windows.map(w => 
          w.id === id ? { 
            ...w, 
            maximized: !w.maximized,
            // Store previous size/position for restoring
            prevWidth: w.maximized ? w.prevWidth : w.width,
            prevHeight: w.maximized ? w.prevHeight : w.height,
            prevX: w.maximized ? w.prevX : w.x,
            prevY: w.maximized ? w.prevY : w.y
          } : w
        ));
      };
      
      const resizeWindow = (id, width, height, x, y) => {
        setWindows(windows.map(w => 
          w.id === id ? { ...w, width, height, x, y } : w
        ));
      };
      
      const focusWindow = (id) => {
        setActiveWindowId(id);
        setWindows(windows.map(w => 
          w.id === id ? { ...w, minimized: false } : w
        ));
      };
      
      const renderWindowContent = (window) => {
        switch (window.appType) {
          case 'browser':
            return <BrowserApp />;
          case 'explorer':
            return <ExplorerApp onOpenApp={(app) => openWindow('webview', app)} />;
          case 'webview':
            return <WebviewApp url={window.appData.url} content={window.appData.content} />;
          default:
            return <div>Unknown application</div>;
        }
      };
      
      if (!loggedIn) {
        return <LoginScreen onLogin={(name) => { setUsername(name); setLoggedIn(true); }} />;
      }
      
      return (
        <div>
          <div className="desktop">
            <DesktopIcon
              icon="üåê"
              label="Browser"
              onDoubleClick={() => openWindow('browser')}
            />
            <DesktopIcon
              icon="üìÅ"
              label="File Explorer"
              onDoubleClick={() => openWindow('explorer')}
            />
            
            {desktopApps.map(app => (
              <DesktopIcon
                key={app.id}
                icon={app.icon}
                label={app.title}
                onDoubleClick={() => openWindow('webview', app)}
              />
            ))}
            
            {windows.map(window => (
              <WindowFrame
                key={window.id}
                window={window}
                isActive={activeWindowId === window.id}
                onClose={() => closeWindow(window.id)}
                onFocus={() => focusWindow(window.id)}
                onMinimize={() => minimizeWindow(window.id)}
                onMaximize={() => maximizeWindow(window.id)}
                onResize={resizeWindow}
              >
                {renderWindowContent(window)}
              </WindowFrame>
            ))}
          </div>
          
          <div className="taskbar">
            <div
              className={`start-button ${startMenuOpen ? 'active' : ''}`}
              onClick={() => setStartMenuOpen(!startMenuOpen)}
              onTouchEnd={(e) => {
                e.preventDefault();
                e.stopPropagation();
                setStartMenuOpen(!startMenuOpen);
              }}
            >
              <span style={{ fontSize: '16px' }}>‚äû</span>
              <span>Start</span>
            </div>
            
            <div className="taskbar-buttons">
              {windows.filter(w => !w.minimized).map(window => (
                <div
                  key={window.id}
                  className={`taskbar-button ${activeWindowId === window.id ? 'active' : ''}`}
                  onClick={() => focusWindow(window.id)}
                  onTouchEnd={(e) => {
                    e.preventDefault();
                    focusWindow(window.id);
                  }}
                >
                  {window.title}
                </div>
              ))}
            </div>
            
            <div className="clock">
              {time.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}
            </div>
          </div>
          
          {startMenuOpen && (
            <div className="start-menu">
              <div className="start-menu-header">InterOS</div>
              <div 
                className="start-menu-item" 
                onClick={() => openWindow('browser')}
                onTouchEnd={(e) => {
                  e.preventDefault();
                  openWindow('browser');
                }}
              >
                üåê Browser (Install Apps)
              </div>
              <div 
                className="start-menu-item" 
                onClick={() => openWindow('explorer')}
                onTouchEnd={(e) => {
                  e.preventDefault();
                  openWindow('explorer');
                }}
              >
                üìÅ File Explorer
              </div>
              <div 
                className="start-menu-item" 
                onClick={() => { setLoggedIn(false); setWindows([]); setStartMenuOpen(false); }}
                onTouchEnd={(e) => {
                  e.preventDefault();
                  setLoggedIn(false);
                  setWindows([]);
                  setStartMenuOpen(false);
                }}
              >
                üö™ Log Off {username}
              </div>
            </div>
          )}
        </div>
      );
    }

    // Render
    ReactDOM.render(<OS />, document.getElementById('root'));
  </script>
</body>
</html>
